# ============================================
# Pre-commit : V√©rification taille du diff + Lint
# ============================================

# --- 1. V√©rification de la taille du diff ---
# Compte les lignes modifi√©es (ajout√©es + supprim√©es) dans les fichiers staged
# Exclut : package-lock.json, fichiers .svg, node_modules/

MAX_LINES=150

# Compter les lignes ajout√©es et supprim√©es, en excluant les fichiers non pertinents
diff_lines=$(git diff --cached --numstat \
  -- . \
  ':!package-lock.json' \
  ':!*.svg' \
  ':!node_modules/' \
  | awk '{ added += $1; removed += $2 } END { print added + removed }')

# Si pas de diff (fichiers exclus uniquement), mettre √† 0
diff_lines=${diff_lines:-0}

if [ "$diff_lines" -gt "$MAX_LINES" ]; then
  echo ""
  echo "‚ùå Commit trop volumineux ! ($diff_lines lignes modifi√©es, max $MAX_LINES)"
  echo ""
  echo "Pourquoi cette limite ?"
  echo "  Commiter par petits blocs logiques permet de :"
  echo "  - Mieux suivre l'historique du projet"
  echo "  - Faciliter la revue de code"
  echo "  - Isoler les bugs plus facilement"
  echo ""
  echo "üí° Comment d√©couper votre commit :"
  echo "  1. git reset HEAD          (d√©sindexer tous les fichiers)"
  echo "  2. git add fichier1.tsx    (ajouter un fichier √† la fois)"
  echo "  3. git commit -m \"feat: ...\" (commiter un petit bloc logique)"
  echo "  4. R√©p√©ter pour le reste"
  echo ""
  echo "üì¶ Fichiers exclus du comptage : package-lock.json, *.svg"
  echo ""
  exit 1
fi

# --- 2. Lint avec Biome ---
npm run lint
